# "Таблица переходных ключей"

- ["Таблица переходных ключей"](#таблица-переходных-ключей)
  - [Подсистема "Таблица переходных ключей"](#подсистема-таблица-переходных-ключей)
    - [Объекты подсистемы](#объекты-подсистемы)
    - [Программный интерфейс](#программный-интерфейс)
    - [Примеры использования](#примеры-использования)

## Подсистема "Таблица переходных ключей"

Подсистема предназначена для хранения индентификатаров объектов интеграционных систем.

### Объекты подсистемы

- **Регистр сведений "Таблица переходных ключей ERP"** - хранилище индентификатаров объектов интеграционных систем.
  - Измерения:
    - ИдентификаторОбъекта - Строка(36) - индентификатор объекта, уникальный ключ.
    - ВидИдентификатораСтрока - Строка(50) - идентификатор описания интеграционного потока ( idflow ). Формируется по шаблону {МетаданныеПолноеИмяМастерСистема}\_{МастерСистема}\_{ВидКлюча},
УНИКУМ использует цифровой код. Описания используемых idflow хранится в служебном обработчике Datareon ESB ["ИдентификаторыПотоковESB"](/integration/adrequest/ИдентификаторыПотоковESB.bsl).
Для просмотра текущих idflow используется отчет  ["Получение записей идентфикаторов потоков ESB"](/integration/adrequest/ПолучитьЗаписиИдентфикаторыПотоковESB.epf)
    - ОбъектERP - ЛюбаяСсылка - ссылка на объект базы данных.
    - ВнешняяСистема - СправочникСсылка.грСистемыИнтеграционногоКонтура - система источник
  - Ресурсы:
    - Версия - Строка(36) - версия ИдентификаторОбъекта
    - Удален - Булево - признак непосредственного удаления в системе источник
  - Реквизиты:
    - ДатаОбновления - Дата - дата обновления записи.
    - ДатаДокумента - Дата - не используется.
    - НомерДокумента - Дата - не используется.

### Программный интерфейс

Программный итерфейс расположен в общем модуле "грОбработкаПакетовИнтеграции" область "ПрограммныйИнтерфейс_РС_грТаблицаПереходныхКлючейERP".

- **УстановитьКлюч_v2**
  
  Функция устанавливает уникальный идентификатор объекта

  Синтаксис

```bsl
// Функция устанавливает уникальный идентификатор объекта
//
// Параметры:
//  СсылкаНаОбъект                  - ЛюбаяСсылка   - Ссылка на объект для записи
//  Ключ                    - Строка        - идентификатора объекта
//  СистемаОбмена          - СправочникСсылка.грСистемыИнтеграционногоКонтура - имя внешней системы
// УстанавливаемыеРеквизиты - Структура - См ПолучитьПараметрыУстановкиИндентификатораОбъекта:
//    * Версия - Строка,Число - версия идентификатора объекта, необяазательный, необязательный
//    * ДатаОбновления - Дата - дата обновления записи, по умолчанию устанавливается текущая дата сеанса , необязательный
//    * Удален - Булево - признак непостредственного удаления объекта, необязательный
//    * ВидИдентификатораСтрока - Строка - идентификатор описания интеграционного потока дозапросов,
//   используемые  виды индентификаторов хранится в служебном обработчике Datareon ESB ["ИдентификаторыПотоковESB"], обязательный 
//
// Возвращаемое значение
//  Булево
//
Функция УстановитьКлюч_v2( СсылкаНаОбъект, Ключ, СистемаОбмена, УстанавливаемыеРеквизиты = Неопределено) Экспорт
```

  Пример вызова

```bsl
   
   ПараметрыКлюча = грОбработкаПакетовИнтеграции.ПолучитьПараметрыУстановкиИндентификатораОбъекта();
   ПараметрыКлюча.Версия = 1;
   ПараметрыКлюча.ВидИдентификатораСтрока = "УНИКУМGUID";
   ПараметрыКлюча.Удален = Истина;

   грОбработкаПакетовИнтеграции.УстановитьКлюч_v2(
    СсылкаНаДокумент, 
    Ключ, 
    СистемаОтправитель,  
    ПараметрыКлюча );

```

- **ПолучитьОбъектПоКлючуТПК**

  Функция ищет объект по индентификатору объекта в регистре сведений "Таблица переходных ключей ERP"

  Синтаксис

```bsl
/// Функция ищет объект по ключу ТПК
// Параметры:
//  Ключ - Строка - идентификатор объекта;
//  МетаданныеПолноеИмя - Строка - полное имя метаданных;
//  ВидИдентификатора - Строка - вид идентификатора;
//  ПараметрыОбработкиСообщения - Структура - см. ПолучитьПараметрыОбработкиСообщения.
// Возвращаемое значение: Структура
//  Ссылка - ссылка на найденный объект или Неопределено, если объект не найден;
//  ДатаИзменения - Дата - дата последнего изменения объекта;
//  ИзменениеРазрешено - Булево;
//  Объект - СправочникОбъект, ДокументОбъект или Неопределено, если объект не найден или ИзменениеРазрешено = Ложь.
//
Функция ПолучитьОбъектПоКлючуТПК(Ключ, МетаданныеПолноеИмя, ВидИдентификатора,
         ПараметрыОбработкиСообщения = Неопределено, 
         Версия = Неопределено,
         ДополнительныеПараметры = Неопределено) Экспорт
```
  
  Пример вызова

```bsl
   
   Ключ = xdtoОбъект.Ссылка;
   
   // Блокировка 
   Если НЕ грОбработкаПакетовИнтеграции.ЗаблокироватьКлючСПопытками(
    Ключ, ВидИдентификатора, ПараметрыОбработки.КоличествоПопытокБлокировки
    ) Тогда 
    
    Если ПараметрыОбработки.МассоваяЗагрузка Тогда 
     ВызватьИсключение "Не удалось выполнить блокировку! Ключ: " + Ключ;
    Иначе
     ОтменитьТранзакцию();
     СостояниеСообщения = Перечисления.сшпСтатусыСообщений.ОжиданиеОбработки;
     Задержка = ПараметрыОбработки.ЗадержкаПриНеудачнойБлокировке;
     Перейти ~Возврат;
    КонецЕсли;
   КонецЕсли;
   
   ВерсияОбъекта = грОбработкаПакетовИнтеграции.ЗначениеРеквизита(xdtoОбъект, "Версия", "Число",, 0);

   
   // Поиск объекта
   сткРезультатПоиска = грОбработкаПакетовИнтеграции.ПолучитьОбъектПоКлючуТПК(
   Ключ, ИмяТипаОбъекта, ВидИдентификатора, ПараметрыОбработки, ВерсияОбъекта
   );
      
```

- **НайтиОбъектПоКлючу**

```bsl
// Функция ищет объект по ключу. Если не найден возвращает новую ссылку. 
// Параметры:
//  Ключ                            - Строка    - ИдентификаторОбъекта для поиска объектов
//  МетаданныеПолноеИмя             - Строка    - полное имя метаданных
//  СистемаОбмена                   - СправочникСсылка.грСистемыИнтеграционногоКонтура - имя внешней системы
//  ВидИдентификатора    - Строка    - вид идентификатора
//  ИдентификаторПотока    - Строка - идентификатор потока дозапроса или его мнемокод
// ТаблицаНенайденных    - ТаблицаЗначений - см. СоздатьТаблицуНенайденныхОбъектов
//  КэшСсылок      - Соответствие - кэш ссылок
//  ДопПараметры     - Структура, может содержать поле ВидИдентификатора
//  Возвращаемое значение:
//  ЛюбаяСсылка - результат поиска/создания объекта 
//  В структуре ДопПараметры возвращает флаг ОбъектНайден и дату изменения найденного объекта ДатаИзменения
//
Функция НайтиОбъектПоКлючу(Ключ, МетаданныеПолноеИмя, 
       ВидИдентификатора = "", 
       ИдентификаторПотока = "", 
       ТаблицаНенайденных = Неопределено, 
       КэшСсылок = Неопределено,
       ДопПараметры = Неопределено
       ) Экспорт

```

  Пример вызова

```bsl
   
//Организация
   ДокОбъект.Организация = грОбработкаПакетовИнтеграции.НайтиОбъектПоКлючу(xdtoОбъект.Организация,
    "Справочник.Организации", ВидИдентификатора, "228", НенайденныеОбъекты, КэшСсылок, ДопПараметрыДозапросов );
      
```

### Примеры использования

Программный интерфейс реализован в общем модуле грОбработкаПакетовИнтеграции область "Дозапросы".

Пример использования ["Пример обработчика Datareon ESB"](/integration/adrequest/ПримерВходящегоОбработчика.bsl).