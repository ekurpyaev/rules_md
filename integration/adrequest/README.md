# "Дозапросы"

- ["Дозапросы"](#дозапросы)
  - [Условные обозначения](#условные-обозначения)
  - [Подсистема "Дозапросы"](#подсистема-дозапросы)
    - [Формат дозапроса](#формат-дозапроса)
    - [Программный интерфейс](#программный-интерфейс)
    - [Объекты подсистемы](#объекты-подсистемы)
    - [Программный интерфейс](#программный-интерфейс-1)

## Условные обозначения

Дозапрос - запрос на недостающие данные в системы интеграционного контура.

## Подсистема "Дозапросы"

Подсистема предназначена для отправки, обработки дозапросов формируемые при обработке сообщений Datareon ESB.

Поддерживается два режима работы:

- Оперативный. Дозапрос отправляются в момент обработки сообщения.
- Отложенный. Дозапрос и сообщение Datareon ESB записываются в промежуточные хранилища ["Объекты подсистемы"](#объекты-подсистемы).
Включение отложенного режима регулируется **константой "Использовать отложенные дозапросы"** с использованием во входящих обработчиках программного [интерфейса](#программный-интерфейс):

### Формат дозапроса

Дозапрос представлен в виде xml пакета с обязательным набором тегов:

- ID - идентификатор объекта ( уникальный ключ)
- Class - идентификатор интеграционного потока, именуемый далее idflow. Описание идентификаторов хранится в служебном обработчике DatareonESB "ИдентификаторыПотоковESB".
idflow формируется по шаблону {МетаданныеПолноеИмяМастерСистема}_{МастерСистема}_{ВидКлюча}, для системы УНИКУМ возможно использование цифрого кода. Пример настроечного файл описания idflow [Идентификаторы потоков ESB](ИдентификаторыПотоковESB.bsl).
Для просмотра текущих idflow используется отчет  ["Получение записей идентфикаторов потоков ESB"](ПолучитьЗаписиИдентфикаторыПотоковESB.epf).

```xml
<classData xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ID> 618 C5AN1001</ID>
  <Class>320</Class>
</classData>

<classData xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ID> 618 C5AN1001</ID>
  <Class>497_Bitrix_BITRIXGUID</Class>
</classData>
```

### Программный интерфейс

-**ЗаписатьОтложенныеДозапросы**
 Записывает отложенные дозапросы по таблице ненайденных объектов
Синтаксис

 Процедура ЗаписатьОтложенныеДозапросы( ID, МетаданныеПолноеИмя, Класс, Знач xdtoОбъект,
ПараметрыОбработки, ТаблицаНенайденных = Неопределено, ДопПараметры = Неопределено ) Экспорт
// Параметры:
// ID                            - Строка    - ИдентификаторОбъекта инициатора дозапроса
// Класс                           - Строка    - класс инициатора дозапроса
// МетаданныеПолноеИмя - Строка - полное имя метаданных
// xdtoОбъект                      - ОбъектXDTO - загружаемый пакет
// ТаблицаНенайденных    - ТаблицаЗначений - см. СоздатьТаблицуНенайденныхОбъектов
// ПараметрыОбработки    - Структура, параметры обработки пакета
// ДопПараметры     - Структура, может содержать поле ВидИдентификатора
//  * Дата - Дата - дата загружаемого объекта, используется для контроля загрузки исторических данных

Пример вызова

```bsl
  ТаблицаИдентификаторовПотоков = грОбработкаПакетовИнтеграцииПовтИсп.ПолучитьТаблицуИдентификаторыПотоковESB();

  ДопПараметрыДозапросов = Новый Структура;
  ДопПараметрыДозапросов.Вставить("ID", Ключ);
  ДопПараметрыДозапросов.Вставить("Класс", КлассСообщения);

  ДокОбъект.Договор = грОбработкаПакетовИнтеграции.НайтиОбъектПоКлючу(xdtoОбъект.Договор,
    "Справочник.ДоговорыКонтрагентов", "УНИКУМGUID", "229", НенайденныеОбъекты, КэшСсылок, ДопПараметрыДозапросов);

  ДопПараметры.Вставить( "Дата", ДокОбъект.Дата); 
  грОбработкаПакетовИнтеграции.ЗаписатьОтложенныеДозапросы( Ключ, ИмяТипаОбъекта, КлассСообщения, xdtoОбъект, ПараметрыОбработки, НенайденныеОбъекты, ДопПараметры );
```

### Объекты подсистемы

- **Константа "Использовать дозапросы"** - отвечает за включение подсистемы "Дозапросы".
- **Константа "Использовать отложенные дозапросы"** - отвечает за включение режима отложенных дозапросов.
- **Регистр сведений "Очередь дозапросов"** -  хранилище запросов.

![Очередь дозапросов](Очередь дозапросов.png)

- **Регистр сведений "Источники дозапросов"** - хранилище дозапросов.
- ["Исходящий обработчик"](Request.Out.bsl) - Исходящий обработчик Datareon ESB.

### Программный интерфейс

Программный интерфейс реализован в общем модуле грОбработкаПакетовИнтеграции область "Дозапросы".

Пример использования ["Пример обработчика Datareon ESB"](ПримерВходящегоОбработчика.bsl).
