# "Задания отложенной обработки данных"

- ["Отложенное проведение"](#отложенное-проведение)
  - [Подсистема "Отложенное проведение"](#подсистема-отложенное-проведение)
    - [Объекты подсистемы](#объекты-подсистемы)
    - [Примеры использования](#примеры-использования)

## Подсистема "Задания отложенной обработки данных"

Подсистема предназначена для передачи промежуточных результатов обработки сообщений Datareon ESB при повторной обработке.

### Объекты подсистемы

- **Регистр сведений "Задания отложенной обработки данных"** - хранилище очереди документов отложенного проведения.
- [**Служебный обработчик "Служебный_ПроведениеДокументовЕРП.Out"**](Служебный_ПроведениеДокументовЕРП.Out.bsl) - служебный обработчик Datareon ESB формирующий записи в **Регистр сведений "Отложеннное проведение"**.
- **Общий модуль "грОтложеннаяОбработкаДанныхСервер"** - программный интерфейс подсистемы.

### Примеры использования

```bsl
  

  МассивИдУдачноОбработанныхСделок = Новый Массив;
  УИДСообщения = Новый УникальныйИдентификатор(Идентификатор);
  
  НужноСохранятьУспешноОбработанныеСделки = xdtoОбъект.Data.Последовательность().Количество() > 1;
  Если НужноСохранятьУспешноОбработанныеСделки Тогда
   ЗапросИдОбработанныхСделок = Новый Запрос;
   ЗапросИдОбработанныхСделок.Текст = 
   "ВЫБРАТЬ ПЕРВЫЕ 1
   | грЗаданияОтложеннойОбработкиДанных.Данные КАК Данные
   |ИЗ
   | РегистрСведений.грЗаданияОтложеннойОбработкиДанных КАК грЗаданияОтложеннойОбработкиДанных
   |ГДЕ
   | грЗаданияОтложеннойОбработкиДанных.Задание = &Задание";
   ЗапросИдОбработанныхСделок.УстановитьПараметр("Задание", УИДСообщения);
   
   РезультатЗапросаПоИдОбработанныхСделок = ЗапросИдОбработанныхСделок.Выполнить();
   Если не РезультатЗапросаПоИдОбработанныхСделок.Пустой() Тогда
    Выборка = РезультатЗапросаПоИдОбработанныхСделок.Выбрать();
    Выборка.Следующий();
    МассивИдУдачноОбработанныхСделок = Выборка.Данные.Получить();
   КонецЕсли;
  КонецЕсли;

////////////////////////
///...
///Обработка сделки
///....
///////////////////////

Если НужноСохранятьУспешноОбработанныеСделки Тогда
   НаборОтложеннойОбработкиДанных = РегистрыСведений.грЗаданияОтложеннойОбработкиДанных.СоздатьНаборЗаписей();
   НаборОтложеннойОбработкиДанных.Отбор.Задание.Установить(УИДСообщения);
   
   Если МассивИдУдачноОбработанныхСделок.Количество() = Последовательность.Количество() Тогда
    //Прогрузили все сделки текущего пакета, больше не нужен массив частично прогруженных сделок
    НаборОтложеннойОбработкиДанных.Записать(Истина);
   Иначе
    ЗаписьУспешноОбработанныхСделок = НаборОтложеннойОбработкиДанных.Добавить();
    
    ЗаписьУспешноОбработанныхСделок.Задание = УИДСообщения;
    ЗаписьУспешноОбработанныхСделок.Процесс = Новый УникальныйИдентификатор;
    ЗаписьУспешноОбработанныхСделок.Данные = Новый ХранилищеЗначения(МассивИдУдачноОбработанныхСделок);
    ЗаписьУспешноОбработанныхСделок.Описание = "Массив удачно обработанных сдеок из обработчика 428 класса, количество " + Строка(МассивИдУдачноОбработанныхСделок.Количество());
    ЗаписьУспешноОбработанныхСделок.ДатаОбновления = ТекущаяДата();
    
    НаборОтложеннойОбработкиДанных.Записать(Истина);
   КонецЕсли;
КонецЕсли;

```

Пример использования ["Пример обработчика Datareon ESB"](ПримерВходящегоОбработчика.bsl).
